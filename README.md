# jmh-benchmark-action

[![Tests](https://github.com/volodya-lombrozo/jmh-benchmark-action/actions/workflows/tests.yml/badge.svg)](https://github.com/volodya-lombrozo/jmh-benchmark-action/actions/workflows/tests.yml)

`jmh-benchmark-action` is a GitHub Action designed to automate the process of
running Java Microbenchmark Harness ([JMH](https://github.com/openjdk/jmh))
benchmarks on pull requests.
It compares the performance results against the base branch to identify any
performance regressions or improvements.
This action is particularly useful for developers who want to ensure that their
code changes do not negatively impact the performance of their applications.

## How It Works

The `jmh-benchmark-action` automates the process of running JMH benchmarks on
both the pull request and the base branch, and then compares the results to
identify
performance changes. Here's a simplified overview of the process:

1. **Check Out Branches**: The action checks out both the pull request branch
   and the base branch.

2. **Run Benchmarks**: It runs the specified benchmark command on both branches
   to generate benchmark results.

3. **Compare Results**: The action compares the benchmark results from the two
   branches and generates a report highlighting any performance gains or losses.

4. **Upload Artifacts**: The action uploads the benchmark comparison report as
   artifacts for further use, such as posting comments on the pull request.

## Table of Contents

- [Installation](#installation)
- [Print messages to a personal repository](#personal-repository-messages)
- [Print messages to an open source repository](#open-source-repository-messages)
- [Similar Solutions](#similar-solutions)
- [Contributing](#contributing)
- [License](#license)

## Installation

To add a JMH benchmark action to your repository, create a new file in
the `.github/workflows` directory with the following content.

```yaml
name: Performance Regression Check
on:
  pull_request:
    branches:
      - main

jobs:
  benchmark:
    name: JMH
    runs-on: ubuntu-latest
    steps:
      - name: Run JMH Benchmark Action
        uses: volodya-lombrozo/jmh-benchmark-action@main
        with:
          java-version: "11"
          base-ref: "main"
          benchmark-command: |
            mvn jmh:benchmark -Djmh.rf=json -Djmh.rff=benchmark.json
          benchmark-file: "benchmark.json"
```

This action will run JMH benchmarks on every pull request to the `main` branch.
The action will compare the results of the benchmarks with the results of the
benchmarks on the `main` branch and print a comment with the results of the
comparison.

<details>
<summary> Message Example </summary>

### üöÄ Performance Analysis

| Test                                             | Base Score | PR Score | Change | % Change | Unit  | Mode         |
|--------------------------------------------------|------------|----------|--------|----------|-------|--------------|
| `com.github.lombrozo.xnav.XnavBenchmark.element` | 5.685      | 5.640    | -0.045 | -0.79%   | us/op | Average Time |
| `com.github.lombrozo.xnav.XnavBenchmark.xpath`   | 8.973      | 9.089    | 0.116  | 1.30%    | us/op | Average Time |

‚úÖ Performance gain: `com.github.lombrozo.xnav.XnavBenchmark.element` is faster
by 0.045 us/op (0.79%)

‚ö†Ô∏è Performance loss: `com.github.lombrozo.xnav.XnavBenchmark.xpath` is slower by
0.116 us/op (1.30%)

</details>

## Personal Repository Messages

If you use `jmh-benchmark-action` in your personal repository, you can print the
benchmark results directly within the same workflow:

```yaml
name: Performance Regression Check
on:
  pull_request:
    branches:
      - main

jobs:
  benchmark:
    name: JMH
    runs-on: ubuntu-latest
    steps:
      - name: Run JMH Benchmark Action
        uses: volodya-lombrozo/jmh-benchmark-action@main
        with:
          java-version: "11"
          base-ref: "main"
          benchmark-command: |
            mvn jmh:benchmark -Djmh.rf=json -Djmh.rff=benchmark.json
          benchmark-file: "benchmark.json"
      - name: Post a Comment with Benchmark Results
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = 'benchmark-comment.md';
            let commentBody = '';
            if (fs.existsSync(path)) {
              commentBody = fs.readFileSync(path, 'utf8');
            } else {
              commentBody = 'No benchmark comparison available.';
            }
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
```

This works because `GITHUB_TOKEN` is a secret token that is automatically
generated by GitHub Actions and has the necessary permissions to post comments
to the repository if the repository is owned by the user who created the token.

## Open Source Repository Messages

In case you use `jmh-benchmark-action` in an open-source repository, you need
to solve the issue with the permissions to post comments. By default, all the
pull requests from forks do not have access to the secrets of the repository.
Moreover, `GITHUB_TOKEN` has only read permissions to the repository.

To solve this issue, it's better to split benchmark generation and comment
posting into two separate workflows. The first workflow will generate the
benchmark results and save them to a file. The second workflow will read the
file and post the comment with the benchmark results.
By doing this, you avoid the need to give write permissions to the forked
repositories.

For example, here is how you can split the workflow. Benchmark workflow:

```yaml
name: Performance Regression Check
on:
  pull_request:
    branches:
      - main

jobs:
  benchmark:
    name: JMH
    runs-on: ubuntu-latest
    steps:
      - name: Run JMH Benchmark Action
        uses: volodya-lombrozo/jmh-benchmark-action@main
        with:
          java-version: "11"
          base-ref: "main"
          benchmark-command: |
            mvn jmh:benchmark -Djmh.rf=json -Djmh.rff=benchmark.json
          benchmark-file: "benchmark.json"
```

And the comment posting workflow:

```yaml
name: Post Benchmark Comment
on:
   workflow_run:
      workflows: [ "Performance Regression Check" ]
      types:
         - completed

jobs:
   post-comment:
      timeout-minutes: 15
      runs-on: ubuntu-24.04
      steps:
         - name: Download PR Number and Benchmark Comment
           uses: actions/download-artifact@v4
           with:
              run-id: ${{ github.event.workflow_run.id }}
              github-token: ${{ secrets.GITHUB_TOKEN }}
         - name: Read and display PR Number
           run: |
              PR_NUMBER=$(cat pr-number/pr-number)
              echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_ENV"
              echo "The PR number is $PR_NUMBER"
         - name: Post Comment on PR
           uses: mshick/add-pr-comment@v2
           with:
              issue: ${{ env.PR_NUMBER }}
              message-path: |
                 benchmark-comment/benchmark-comment.md
              repo-token: ${{ secrets.GITHUB_TOKEN }}
```

The second workflow starts when the first workflow is completed. It downloads
the benchmark results from the first workflow and posts them as a comment to the
pull request.

Pay attention that the second workflow should be merged into the main branch
before the first workflow is triggered.

## Contributing

We welcome contributions from the community! If you're interested in
contributing to this project, please follow these guidelines:

1. **Code of Conduct**: Please read and adhere to
   our [Code of Conduct](CODE_OF_CONDUCT.md) to ensure a welcoming and inclusive
   environment for everyone.

2. **Issues**: If you encounter a bug or have a feature request, please open an
   issue. Provide as much detail as possible to help us understand and address
   your concern.

3. **Pull Requests**: We use
   a [pull request template](.github/pull_request_template.md) to help you
   structure your contributions. Please fill it out completely when submitting a
   pull request.

4. **Development**:
    - Fork the repository and create a new branch for your feature or bug fix.
    - Write clear, concise commit messages.
    - Ensure your code follows the project's style guidelines and passes all
      tests.

5. **Review Process**: All contributions will be reviewed by our maintainers. We
   may ask for changes or clarifications before merging your pull request.

Thank you for your interest in contributing to our project!

## Similar Solutions

If you're exploring alternatives to `jmh-benchmark-action`, you might consider
the following solutions:

1. [benchmark-action/github-action-benchmark](https://github.com/benchmark-action/github-action-benchmark):
   A popular GitHub Action for running benchmarks on pull requests. It supports
   multiple languages and frameworks, including Java and JMH. However, you
   might encounter issues with posting comments to the pull request.
2. [kitlangton/jmh-benchmark-action](https://github.com/kitlangton/jmh-benchmark-action):
   A GitHub Action that runs JMH benchmarks on pull requests and posts the
   results as comments. Similar to `jmh-benchmark-action`, but it hasn't been updated
   for a while. You might give it a try and see if it fits your needs.

## License

This project is licensed under the MIT License ‚Äî see the [LICENSE](LICENSE) file
for details.

